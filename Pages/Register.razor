@using Veterinaria.Data
@using Veterinaria.Service

@page "/registrar-dueno"
@inject NavigationManager Navigation
@inject RenaperService RenaperService
@inject OwnerService OwnerService // --- NUEVO ---

<div class="form-container">
    <header class="form-header">
        <h1>Registrar Dueño</h1>
        <p>Complete los datos del propietario de la mascota</p>
    </header>

    <EditForm Model="@owner" OnValidSubmit="Submit" class="form">
        <DataAnnotationsValidator />

        <div class="form-group">
            <label for="nombre">Nombre Completo *</label>
            <InputText id="nombre" @bind-Value="owner.NombreCompleto" required placeholder="Ingrese el nombre completo" />
            <ValidationMessage For="@(() => owner.NombreCompleto)" />
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="dni">DNI *</label>
                <InputText id="dni" @bind-Value="owner.Dni" required placeholder="12345678" />
                <ValidationMessage For="@(() => owner.Dni)" />
            </div>

            <div class="form-group">
                <label for="fechaNacimiento">Fecha de Nacimiento *</label>
                <InputDate id="fechaNacimiento" @bind-Value="owner.FechaNacimiento" required />
                <ValidationMessage For="@(() => owner.FechaNacimiento)" />
            </div>
        </div>

        <div class="form-group">
            <label for="domicilio">Domicilio *</label>
            <InputText id="domicilio" @bind-Value="owner.Domicilio" required placeholder="Calle, número, ciudad" />
            <ValidationMessage For="@(() => owner.Domicilio)" />
        </div>

        <div class="form-group">
            <label for="sexo">Sexo *</label>
            <InputSelect id="sexo" @bind-Value="owner.Sexo" required>
                <option value="">Seleccione una opción</option>
                <option value="M">Masculino</option>
                <option value="F">Femenino</option>
                <option value="O">Otro</option>
            </InputSelect>
            <ValidationMessage For="@(() => owner.Sexo)" />
        </div>

        <div class="form-actions">
            <button type="button" class="btn btn-secondary" @onclick="Cancel">
                Cancelar
            </button>
            <button type="submit" class="btn btn-primary">
                Guardar Dueño
            </button>
        </div>

        @if (buscando)
        {
            <p class="text-info">Buscando datos...</p>
        }
        @if (errorDni != null)
        {
            <p class="text-danger">@errorDni</p>
        }
        @if (saveMessage != null)
        {
            <p class="text-success">@saveMessage</p>
        }

    </EditForm>
</div>


@code {
    private bool buscando = false;
    private string? errorDni = null;
    private string? saveMessage = null; // Para feedback

    private Owner owner = new Owner();

    private async Task BuscarOwnerPorDni()
    {
        // El servicio Renaper sigue sin un endpoint real,
        // así que esta lógica se mantiene comentada como en el original.
        //
        buscando = false;
    }

    private async Task Submit()
    {
        saveMessage = null;
        
        // --- LÓGICA DE GUARDADO ---
        bool guardado = await OwnerService.SaveOwner(owner);

        if (guardado)
        {
            saveMessage = "¡Dueño guardado con éxito!";
            // Redirigir después de 2 segundos
            await Task.Delay(2000);
            Navigation.NavigateTo("/");
        }
        else
        {
            saveMessage = "Error al guardar el dueño.";
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/");
    }
}